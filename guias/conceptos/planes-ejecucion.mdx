---
title: "Planes de Ejecucion"
description: "Como Pan genera y ejecuta estrategias optimizadas"
---

Los Planes de Ejecucion son estrategias detalladas que Pan genera automaticamente para lograr tus intents. Describen exactamente que operaciones se realizaran, en que orden, y con que costos esperados.

## Como Funciona la Planificacion

Cuando creas un intent, Pan no ejecuta inmediatamente. Primero pasa por una fase de planificacion sofisticada:

```mermaid
flowchart TB
    subgraph Phase1["1. ANALISIS DE ESTADO"]
        A1["Consultar balances<br/>en todas las chains"]
        A2["Identificar tokens<br/>disponibles"]
        A3["Calcular totales<br/>por asset"]
        A1 --> A2 --> A3
    end

    subgraph Phase2["2. EVALUACION DE PROTOCOLOS"]
        B1["Obtener APYs de<br/>Aave en cada chain"]
        B2["Verificar liquidez<br/>disponible"]
        B3["Evaluar riesgo<br/>de protocolo"]
        B1 --> B2 --> B3
    end

    subgraph Phase3["3. OPTIMIZACION DE RUTA"]
        C1["Calcular opciones<br/>de bridge"]
        C2["Estimar costos<br/>de gas por ruta"]
        C3["Comparar costo<br/>total vs beneficio"]
        C4["Seleccionar<br/>ruta optima"]
        C1 --> C2 --> C3 --> C4
    end

    subgraph Phase4["4. GENERACION DE PLAN"]
        D1["Ordenar<br/>operaciones"]
        D2["Calcular amounts<br/>exactos"]
        D3["Estimar<br/>tiempo total"]
        D1 --> D2 --> D3
    end

    Phase1 --> Phase2 --> Phase3 --> Phase4
    Phase4 --> Result([ExecutionPlan])

    style Phase1 fill:#e3f2fd,stroke:#1976d2
    style Phase2 fill:#e8f5e9,stroke:#388e3c
    style Phase3 fill:#fff3e0,stroke:#f57c00
    style Phase4 fill:#fce4ec,stroke:#c2185b
    style Result fill:#c8e6c9,stroke:#2e7d32
```

## Estructura de un Plan de Ejecucion

```json
{
  "strategy": "single-bridge",
  "targetChain": "base",
  "targetProtocol": "aave",
  "expectedApy": 8.52,
  "steps": [
    {
      "type": "bridge",
      "sequence": 1,
      "from": "arbitrum",
      "to": "base",
      "asset": "USDC",
      "amount": "1000",
      "provider": "across",
      "estimatedFee": "1.50",
      "estimatedTime": "2-5 min"
    },
    {
      "type": "deposit",
      "sequence": 2,
      "chain": "base",
      "protocol": "aave",
      "asset": "USDC",
      "amount": "998.50",
      "estimatedGas": "200000",
      "estimatedGasUsd": "0.80"
    }
  ],
  "summary": {
    "totalSteps": 2,
    "estimatedGasUsd": 2.30,
    "estimatedFees": 1.50,
    "estimatedTotalCost": 3.80,
    "estimatedTime": "3-7 min",
    "expectedFinalAmount": "998.50"
  }
}
```

## Tipos de Estrategia

<Info>
  Las estrategias usan nombres internos especificos. Asegurate de usar los nombres correctos en tus integraciones.
</Info>

### direct-deposit

**Cuando se usa:** Los fondos ya estan en la chain con mejor yield.

```
Estado del wallet:
- Base: 1000 USDC
- Mejor APY: Base (8.52%)

Estrategia: direct-deposit
- Solo deposito directo a Aave
- Gas estimado: ~300,000
```

```json
{
  "strategy": "direct-deposit",
  "reasoning": "Funds already on optimal chain",
  "steps": [
    {
      "type": "deposit",
      "chain": "base",
      "protocol": "aave",
      "asset": "USDC",
      "amount": 1000
    }
  ],
  "estimatedGas": 300000,
  "estimatedTime": 30
}
```

### bridge-and-lend

**Cuando se usa:** Los fondos estan concentrados en una chain diferente a la optima.

```
Estado del wallet:
- Arbitrum: 1000 USDC
- Mejor APY: Base (8.52%)

Estrategia: bridge-and-lend
- Bridge Arbitrum -> Base via Across
- Deposito en Aave Base
- Gas estimado: ~450,000
- Fee de bridge: ~0.1%
```

```json
{
  "strategy": "bridge-and-lend",
  "reasoning": "Bridge to chain with best APY",
  "steps": [
    {
      "type": "bridge",
      "fromChain": "arbitrum-sepolia",
      "toChain": "base-sepolia",
      "asset": "USDC",
      "amount": 1000,
      "bridge": "across"
    },
    {
      "type": "deposit",
      "chain": "base-sepolia",
      "protocol": "aave",
      "asset": "USDC",
      "amount": 999
    }
  ],
  "estimatedGas": 450000,
  "estimatedTime": 120
}
```

### multi-bridge-and-lend

**Cuando se usa:** Los fondos estan distribuidos en multiples chains.

```
Estado del wallet:
- Ethereum: 200 USDC
- Arbitrum: 500 USDC
- Base: 300 USDC (ya en destino)
- Mejor APY: Base (8.52%)

Estrategia: multi-bridge-and-lend
- Bridge Ethereum -> Base
- Bridge Arbitrum -> Base
- Deposito consolidado en Aave Base
- Gas estimado: 300,000 + (N x 150,000)
```

```json
{
  "strategy": "multi-bridge-and-lend",
  "reasoning": "Consolidate funds from multiple chains",
  "steps": [
    {
      "type": "bridge",
      "fromChain": "sepolia",
      "toChain": "base-sepolia",
      "asset": "USDC",
      "amount": 200,
      "bridge": "across"
    },
    {
      "type": "bridge",
      "fromChain": "arbitrum-sepolia",
      "toChain": "base-sepolia",
      "asset": "USDC",
      "amount": 500,
      "bridge": "across"
    },
    {
      "type": "deposit",
      "chain": "base-sepolia",
      "protocol": "aave",
      "asset": "USDC",
      "amount": 996
    }
  ],
  "estimatedGas": 600000,
  "estimatedTime": 300
}
```

### simple-withdraw

**Cuando se usa:** Retirar fondos de Aave.

```json
{
  "strategy": "simple-withdraw",
  "reasoning": "Direct withdrawal from Aave",
  "steps": [
    {
      "type": "withdraw",
      "chain": "base-sepolia",
      "protocol": "aave",
      "asset": "USDC",
      "amount": 500
    }
  ],
  "estimatedGas": 250000,
  "estimatedTime": 30
}
```

## Tipos de Pasos

### Bridge

Mueve tokens entre chains usando Across Protocol.

```json
{
  "type": "bridge",
  "from": "arbitrum",
  "to": "base",
  "asset": "USDC",
  "amount": "1000",
  "provider": "across",
  "estimatedFee": "1.50",
  "estimatedTime": "2-5 min",
  "fillDeadline": 7200
}
```

**Campos importantes:**
- `provider`: Siempre `across` (Across Protocol)
- `estimatedFee`: Fee del bridge en USD
- `fillDeadline`: Tiempo maximo para completar (segundos)

### Deposit

Deposita tokens en un protocolo de lending.

```json
{
  "type": "deposit",
  "chain": "base",
  "protocol": "aave",
  "asset": "USDC",
  "amount": "998.50",
  "apy": 8.52,
  "estimatedGas": "200000",
  "estimatedGasUsd": "0.80"
}
```

**Campos importantes:**
- `protocol`: Siempre `aave` actualmente
- `apy`: APY esperado
- `amount`: Cantidad despues de fees de bridge

### Withdraw

Retira tokens de un protocolo de lending.

```json
{
  "type": "withdraw",
  "chain": "base",
  "protocol": "aave",
  "asset": "USDC",
  "amount": "500",
  "estimatedGas": "250000",
  "estimatedGasUsd": "1.00"
}
```

### Swap (Proximo)

Intercambia un token por otro (en desarrollo).

```json
{
  "type": "swap",
  "chain": "arbitrum",
  "fromAsset": "USDT",
  "toAsset": "USDC",
  "amount": "500",
  "provider": "uniswap",
  "estimatedSlippage": "0.1%"
}
```

## Ejecucion del Plan

Una vez generado el plan, Pan ejecuta cada paso en secuencia:

```mermaid
flowchart TB
    Start([Iniciar Ejecucion]) --> Loop

    subgraph Loop["Para cada paso en el plan"]
        direction TB

        subgraph Prep["1. PREPARACION"]
            P1["Verificar balance"]
            P2["Verificar gas"]
            P3["Preparar datos txn"]
        end

        subgraph Exec["2. EJECUCION"]
            E1["Firmar via Privy"]
            E2["Enviar a blockchain"]
            E3["Obtener txHash"]
        end

        subgraph Confirm["3. CONFIRMACION"]
            C1["Esperar 1-2 bloques"]
            C2["Verificar exito"]
            C3["Actualizar estado"]
        end

        subgraph Record["4. REGISTRO"]
            R1["Guardar txHash + gas"]
            R2["Calcular costo USD"]
            R3["Incrementar completedSteps"]
        end

        Prep --> Exec --> Confirm --> Record
    end

    Record --> Check{Mas pasos?}
    Check -->|Si| Loop
    Check -->|No| Success([Completed])

    Confirm --> Fail{Fallo?}
    Fail -->|Si| HandleError["Registrar error<br/>Marcar failed"]
    HandleError --> Failed([Failed])

    style Start fill:#e3f2fd,stroke:#1976d2
    style Success fill:#c8e6c9,stroke:#2e7d32
    style Failed fill:#ffcdd2,stroke:#c62828
    style Prep fill:#e8eaf6,stroke:#3f51b5
    style Exec fill:#fff3e0,stroke:#f57c00
    style Confirm fill:#e8f5e9,stroke:#388e3c
    style Record fill:#fce4ec,stroke:#c2185b
```

### Diagrama de Secuencia Detallado

```mermaid
sequenceDiagram
    participant Engine as Execution Engine
    participant Privy as Privy Wallet
    participant Chain as Blockchain
    participant DB as Database

    loop Para cada paso
        Engine->>Engine: Verificar precondiciones
        Engine->>Privy: Firmar transaccion
        Privy-->>Engine: Transaccion firmada

        Engine->>Chain: Enviar transaccion
        Chain-->>Engine: txHash

        loop Esperar confirmacion
            Engine->>Chain: getTransactionReceipt
            Chain-->>Engine: receipt (o null)
        end

        alt Transaccion exitosa
            Engine->>DB: Guardar resultado
            Engine->>Engine: completedSteps++
        else Transaccion fallida
            Engine->>DB: Registrar error
            Engine-->>Engine: Detener ejecucion
        end
    end
```

## Monitorear Ejecucion

Durante la ejecucion, puedes ver el progreso en tiempo real:

```javascript
const intent = await pan.getIntent(intentId);

console.log('Estado:', intent.status);
console.log('Plan:', intent.executionPlan);
console.log('Resultados:', intent.results);
```

### Respuesta durante ejecucion

```json
{
  "id": "intent_xyz789",
  "status": "executing",
  "executionPlan": {
    "strategy": "single-bridge",
    "steps": [
      {
        "type": "bridge",
        "sequence": 1,
        "status": "completed",
        "txHash": "0x123abc..."
      },
      {
        "type": "deposit",
        "sequence": 2,
        "status": "executing"
      }
    ]
  },
  "results": {
    "completedSteps": 1,
    "transactions": [
      {
        "type": "bridge",
        "txHash": "0x123abc...",
        "chain": "arbitrum",
        "gasUsed": "150000",
        "gasCostUsd": 1.50
      }
    ]
  }
}
```

### Respuesta completada

```json
{
  "id": "intent_xyz789",
  "status": "completed",
  "executionPlan": {
    "strategy": "single-bridge",
    "steps": [
      { "type": "bridge", "sequence": 1, "status": "completed" },
      { "type": "deposit", "sequence": 2, "status": "completed" }
    ]
  },
  "results": {
    "completedSteps": 2,
    "transactions": [
      {
        "type": "bridge",
        "txHash": "0x123abc...",
        "chain": "arbitrum",
        "gasUsed": "150000",
        "gasCostUsd": 1.50
      },
      {
        "type": "deposit",
        "txHash": "0x456def...",
        "chain": "base",
        "gasUsed": "200000",
        "gasCostUsd": 0.80
      }
    ],
    "totalGasUsed": "350000",
    "totalGasCostUsd": 2.30,
    "finalAmount": "998.50",
    "apy": 8.52
  },
  "completedAt": "2024-01-15T10:45:30Z"
}
```

## Optimizacion de Costos

Pan optimiza costos considerando multiples factores:

### Costos de Bridge

```
Bridge fee = base_fee + (amount * percentage_fee)

Ejemplo Across:
- Base fee: ~$0.50
- Percentage: ~0.1%
- 1000 USDC: $0.50 + $1.00 = $1.50 fee
```

### Costos de Gas

```
Gas cost = gas_used * gas_price * eth_price

Ejemplo en Base:
- Gas used: 200,000
- Gas price: 0.001 gwei
- ETH price: $2,500
- Cost: ~$0.50
```

### Decision de Bridge

Pan decide si hacer bridge basandose en:

```
APY_diferencia = APY_mejor_chain - APY_chain_actual
Costo_bridge = fee_bridge + gas_bridge
Tiempo_breakeven = Costo_bridge / (Amount * APY_diferencia / 365)

Si Tiempo_breakeven < 30 dias:
  → Hacer bridge vale la pena
Si no:
  → Depositar en chain actual
```

## Manejo de Fallos

### Durante Bridge

Si un bridge falla:
1. Pan espera hasta `fillDeadline`
2. Si no completa, marca el paso como fallido
3. El intent queda en estado `failed`
4. Los fondos permanecen en la chain origen

```json
{
  "status": "failed",
  "error": {
    "code": "BRIDGE_TIMEOUT",
    "message": "Bridge did not complete within deadline",
    "step": 1
  },
  "results": {
    "completedSteps": 0,
    "failedStep": 1
  }
}
```

### Durante Deposit

Si un deposito falla:
1. Los fondos ya estan en la chain destino
2. Pan intenta diagnosticar el error
3. Puedes reintentar con un nuevo intent

```json
{
  "status": "failed",
  "error": {
    "code": "DEPOSIT_REVERTED",
    "message": "Transaction reverted on chain",
    "step": 2,
    "details": {
      "reason": "Insufficient liquidity in protocol"
    }
  }
}
```

## Verificar Transacciones

Todas las transacciones son verificables on-chain:

```javascript
const intent = await pan.getIntent(intentId);

// Obtener explorers
const explorers = {
  'ethereum': 'https://etherscan.io/tx/',
  'ethereum-sepolia': 'https://sepolia.etherscan.io/tx/',
  'arbitrum': 'https://arbiscan.io/tx/',
  'arbitrum-sepolia': 'https://sepolia.arbiscan.io/tx/',
  'base': 'https://basescan.org/tx/',
  'base-sepolia': 'https://sepolia.basescan.org/tx/'
};

// Mostrar links
intent.results?.transactions?.forEach(tx => {
  const chain = tx.chain;
  const explorer = explorers[chain];
  console.log(`${tx.type}: ${explorer}${tx.txHash}`);
});
```

## Proximos Pasos

<CardGroup cols={2}>
  <Card
    title="Ejecutar Intents"
    icon="play"
    href="/guias/ejecutar-intents"
  >
    Guia practica de ejecucion
  </Card>
  <Card
    title="Monitorear Estado"
    icon="chart-line"
    href="/guias/monitorear-estado"
  >
    Como hacer seguimiento efectivo
  </Card>
  <Card
    title="Manejo de Errores"
    icon="exclamation-triangle"
    href="/guias/mejores-practicas/manejo-errores"
  >
    Estrategias para manejar fallos
  </Card>
  <Card
    title="API de Intents"
    icon="terminal"
    href="/api/intents/crear-intent"
  >
    Referencia del endpoint
  </Card>
</CardGroup>
